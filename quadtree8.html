<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadrilateral Tree Viewer v5.0 (Harmonic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .sidebar { width: 300px; height: 100vh; position: fixed; top: 0; left: 0; background: #fff; border-right: 1px solid #e5e7eb; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; }
        .main-content { margin-left: 300px; padding: 32px; }
        .branch-link { display: block; padding: 10px 16px; border-radius: 8px; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s; }
        .branch-link:hover { background-color: #f3f4f6; }
        .branch-link.active { background-color: #c62828; color: #fff; font-weight: 600; }
        .leaf-card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; }
        .leaf-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .leaf-trait { display: inline-block; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 500; margin-right: 4px; margin-bottom: 4px; }
        .leaf-trait.unclassified { background-color: #fef3c7; color: #92400e; }
        .leaf-trait.q-leaf { background-color: #ede7f6; color: #311b92; border: 1px solid #b39ddb; }
        .leaf-trait.c-leaf { background-color: #e0f2f1; color: #004d40; border: 1px solid #80cbc4; }
        .leaf-trait.l-leaf { background-color: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .leaf-trait.p-leaf { background-color: #fce4ec; color: #880e4f; border: 1px solid #f48fb1; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; max-width: 900px; width: 95%; max-height: 95vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 10px; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #fff; }
        #analysis-results a { color: #93c5fd; text-decoration: underline; cursor: pointer; }
        .sidebar::-webkit-scrollbar { width: 6px; } .sidebar::-webkit-scrollbar-track { background: #f1f1f1; } .sidebar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">The Tree</h1>
            <p class="text-sm text-gray-500 mb-4">Project Quadrilateral</p>
            <button id="openGuideBtn" class="w-full mb-6 bg-gray-800 hover:bg-gray-900 text-white text-sm py-2 px-3 rounded-md transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Taxonomy Guide
            </button>
            <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">The Trunk</h2>
            <div id="tree-controls" class="space-y-1"><a class="branch-link" data-branch="All">Show All Branches</a></div>
            <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-3">The Branches</h2>
        </div>
        <div id="branch-list" class="space-y-1 flex-grow"></div>
    </aside>

    <main class="main-content">
        <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Max Number (N)</label>
                    <input type="number" id="maxLimit" value="2048" min="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Filter Category</label>
                    <select id="leafFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Filter Sub-Type</label>
                    <select id="subLeafFilter" disabled class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm bg-gray-50 text-gray-500">
                        <option value="All">All Sub-Types</option>
                    </select>
                </div>
                <div>
                    <button id="scanButton" class="w-full bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-800 transition">Scan and Classify</button>
                </div>
            </div>

            <div id="summary" class="mt-4 text-sm text-gray-600"></div>
            <hr class="my-6">
            <div class="flex justify-between items-baseline mb-2"><h3 class="text-lg font-medium text-gray-900">Pattern Hunter</h3><span class="text-xs text-gray-400">Targeting Harmonic Anomalies</span></div>
            <button id="findNewButton" class="w-full md:w-auto bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-800 transition">Analyze Anomalies</button>
            <div id="analysis-results" class="mt-4 p-4 bg-gray-800 text-white font-mono rounded-lg shadow-inner text-sm" style="min-height: 100px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">Click "Analyze Anomalies" to categorize the survivors...</div>
            <hr class="my-6">
            <h3 class="text-lg font-medium text-gray-900">Data Exporters</h3>
            <div class="flex gap-4 mt-4">
                <button id="exportButton" class="flex-1 bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-800 transition text-sm">Unclassified JSON</button>
                <button id="exportSimpleButton" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition text-sm">Unclassified List</button>
                <button id="exportDValuesButton" class="flex-1 bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-800 transition text-sm">Linear Factors</button>
            </div>
            <textarea id="export-data" class="mt-4 w-full h-32 p-2 font-mono text-xs bg-gray-100 rounded-md border-gray-300 shadow-inner" readonly placeholder="Export output..."></textarea>
        </div>
        
        <h2 class="text-2xl font-semibold text-gray-900 mb-1">Displaying: <span id="branch-title" class="text-red-700">All</span></h2>
        <p class="mb-6 text-gray-500">Found <span id="leaf-count">0</span> matching families.</p>
        <div id="leaf-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
    </main>

    <div id="familyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-semibold" id="modal-title">Family Details</h3><button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="modal-body" class="space-y-4"></div>
                <div>
                    <h4 class="font-bold text-gray-800 mb-2">Visual Proof (Leaf Geometry)</h4>
                    <p class="text-xs text-gray-500 mb-2">Visualizing the relationship between <em>a</em> and the next member.</p>
                    <div class="chart-container"><canvas id="familyChart"></canvas></div>
                    <h4 class="font-bold text-gray-800 mt-6 mb-2">The Trunk Law (Balance)</h4>
                    <p class="text-xs text-gray-500 mb-2">Proving $d-c = b-a$ (The Geometric Symmetry).</p>
                    <div class="chart-container" style="height: 150px;"><canvas id="gapChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="guideModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-gray-900">Taxonomy Guide</h3><button id="closeGuide" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
            <div class="space-y-8 overflow-y-auto pr-2" style="max-height: 70vh;">
                <div><div class="flex items-center gap-2 mb-2"><span class="leaf-trait q-leaf px-3 py-1 text-sm">Q-Leaf</span><h4 class="font-bold text-lg">The "Curve Benders"</h4></div><p class="text-sm text-gray-600 mb-2">The Universal Class. Includes "Linear" leaves (Slope 1) and all higher orbitals.</p><div class="bg-gray-50 p-3 rounded border text-sm font-mono text-gray-700">Rule: Deviation (K) is a Power of 2 (checked against slopes 1, 2, 4, 8...)</div></div>
                <div><div class="flex items-center gap-2 mb-2"><span class="leaf-trait p-leaf px-3 py-1 text-sm">P-Leaf</span><h4 class="font-bold text-lg">The "Perfect Doublers"</h4></div><p class="text-sm text-gray-600 mb-2">Numbers resonating with the binary system.</p><div class="bg-gray-50 p-3 rounded border text-sm font-mono text-gray-700">Rule: c = a * 2ⁿ</div></div>
                <div><div class="flex items-center gap-2 mb-2"><span class="leaf-trait c-leaf px-3 py-1 text-sm">C-Leaf</span><h4 class="font-bold text-lg">The "Cryptids"</h4></div><p class="text-sm text-gray-600 mb-2">Mersenne Multipliers.</p><div class="bg-gray-50 p-3 rounded border text-sm font-mono text-gray-700">Rule: b = a * (2ⁿ - 1)</div></div>
                <div><div class="flex items-center gap-2 mb-2"><span class="leaf-trait l-leaf px-3 py-1 text-sm">Linear (Resonant)</span><h4 class="font-bold text-lg">The "Harmonic Anomalies"</h4></div><p class="text-sm text-gray-600 mb-2">Survivors that possess factors outside the {2,3} binary set.</p><div class="bg-gray-50 p-3 rounded border text-sm font-mono text-gray-700">Rule: D contains factors like 7, 9, 13, 17...</div></div>
            </div>
            <div class="mt-6 pt-4 border-t text-right"><button onclick="document.getElementById('guideModal').style.display='none'" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900">Close Guide</button></div>
        </div>
    </div>

    <script>
        // --- App State ---
        let allFamilies = [], classifiedData = [], knownLeaves = new Set();
        let currentBranch = "All", currentLeafFilter = "All", currentSubFilter = "All";
        let fibonacciSet = new Set(), currentChart = null, currentGapChart = null;

        // --- Core Math ---
        const toBinary = (n, k) => n.toString(2).padStart(k, '0');
        const binToDec = (s) => parseInt(s, 2);
        const isPowerOfTwo = (n) => n > 0 && (n & (n - 1)) === 0;

        // Helper: Checks if number is Mersenne (2^n - 1)
        const isMersenneNumber = (n) => n > 0 && Number.isInteger(Math.log2(n + 1));

        function generateMatrix(s) {
            const k = s.length, matrix = []; const b1 = s.charAt(0); const s_inv = s.split('').map(b => (b === '1' ? '0' : '1')).join('');
            for (let i = 0; i < k; i++) { if (s.charAt(i) === b1) matrix.push(s.split('')); else matrix.push(s_inv.split('')); }
            return matrix;
        }
        function getRotationalFamily(matrix) {
            const k = matrix.length; let m90=[], m180=[], m270=[];
            for(let i=0; i<k; i++) { m90.push(new Array(k)); m180.push(new Array(k)); m270.push(new Array(k)); }
            for (let i = 0; i < k; i++) { for (let j = 0; j < k; j++) { m90[i][j] = matrix[k - 1 - j][i]; m180[i][j] = matrix[k - 1 - i][k - 1 - j]; m270[i][j] = matrix[j][k - 1 - i]; } }
            return [binToDec(matrix[0].join('')), binToDec(m90[0].join('')), binToDec(m180[0].join('')), binToDec(m270[0].join(''))];
        }
        function getBranchFromSum(sum) {
            const power = Math.log2(sum + 1);
            if (Number.isInteger(power)) return "M" + power;
            return "Unknown";
        }
        function generateFibonacciSet(max) {
            fibonacciSet.clear(); let a = 0, b = 1; while (b <= max) { fibonacciSet.add(b); let temp = a + b; a = b; b = temp; }
        }
        
        // --- NEW: HARMONIC ANALYZER ---
        // Identifies the "Alien Factor" in a linear step
        function getLinearResonance(D) {
            let n = D;
            // Strip all factors of 2
            while (n > 0 && n % 2 === 0) { n = n / 2; }
            
            // If n is 1, it was a power of 2 (caught by Q-Leaf)
            if (n === 1) return null; 
            
            // If n is 3, it was a Tri-Resonance (caught by Q-Leaf)
            if (n === 3) return null; 
            
            // Whatever is left is the Anomaly (7, 9, 13, 17...)
            return n;
        }

        // --- CLASSIFIER ---
        function getLeavesForFamily(family, N, sum) {
            const leaves = []; const [a, b, c, d] = family; let isClassified = false;
            
            // 1. Geometric & Founders
            if (a === 1 && isPowerOfTwo(N)) leaves.push("Power-of-2 Founder");
            
            // 2. Pyth/Fib
            const a2 = a*a, b2 = b*b, c2 = c*c, d2 = d*d;
            if (a > 0 && (a2 + b2 + c2 === d2)) { leaves.push(`Pyth. Quadruple`); isClassified = true; }
            else if (a > 0 && b > 0 && c > 0 && (a2 + b2 === c2)) { leaves.push(`Pyth. Triple`); isClassified = true; }
            else if (!isClassified && fibonacciSet.has(a) && fibonacciSet.has(b) && fibonacciSet.has(c) && fibonacciSet.has(d)) { leaves.push("Fibonacci Family"); isClassified = true; }
            
            // 3. P-Leaves
            if (!isClassified && a > 0 && c % a === 0) {
                const k = c / a;
                if (isPowerOfTwo(k)) { leaves.push(`P-Leaf (c=${k}a)`); isClassified = true; }
            }

            // 4. C-Leaves
            if (!isClassified && a > 0 && b % a === 0) {
                const k = b / a;
                if (k > 1 && isMersenneNumber(k)) { 
                    leaves.push(`C-Leaf (Mersenne x${k})`); isClassified = true; 
                }
            }

            // 5. Q-Leaves (Generalized)
            let isQLeaf = false;
            for (let s = 0; s <= 8; s++) { 
                const slope = 1 << s;       
                const offset = slope - 1;   
                const target = (slope * a) + offset;
                const K = Math.abs(b - target);

                if (K > 0 || (s===0 && K > 0)) { 
                    const validPow2 = isPowerOfTwo(K);
                    const validTriRes = (K % 3 === 0) && isPowerOfTwo(K / 3);

                    if (validPow2 || validTriRes) {
                        leaves.push(`Q-Leaf (${offset}±K)`);
                        isQLeaf = true;
                    }
                }
            }
            if (isQLeaf) isClassified = true;

            // 6. Linear Leaves (Harmonic Anomalies)
            // UPDATED: Now identifies the specific "Alien Factor"
            if (!isClassified) {
                const D = b - a; 
                if (D > 0 && d - c === D) {
                    const alienFactor = getLinearResonance(D);
                    if (alienFactor) {
                        leaves.push(`Linear (x${alienFactor} Resonance)`);
                        isClassified = true;
                    } else {
                        // Should technically be impossible given logic above, but fallback
                        leaves.push(`Linear-Leaf (D=${D})`); 
                        isClassified = true; 
                    }
                }
            }
            
            if (!isClassified) leaves.push("Unclassified");
            
            leaves.forEach(leaf => knownLeaves.add(leaf));
            return leaves;
        }

        // --- Analysis Engine ---
        function getAnalysisText(fam) {
            const [a, b, c, d] = fam.family; const leaves = fam.leaves;
            
            // Prioritize Linear Anomalies in analysis
            const linearTag = leaves.find(l => l.includes('Linear'));
            if (linearTag) {
                const D = b - a;
                const factor = linearTag.includes('x') ? linearTag.split('x')[1].split(' ')[0] : '?';
                return `Analysis: HARMONIC ANOMALY. This family has a linear step D=${D}. It survived because it contains a Prime Factor of ${factor}, which is outside the standard {2, 3} binary resonance.`;
            }

            if (leaves.some(l => l.includes('Pyth'))) return `Analysis: This family forms a Pythagorean relationship ($a^2 + b^2 = c^2$).`;
            if (leaves.some(l => l.includes('Fibonacci'))) return `Analysis: This family consists entirely of Fibonacci numbers.`;
            if (leaves.some(l => l.includes('P-Leaf'))) {
                const l = leaves.find(l => l.includes('c=')); const k = l ? l.split('=')[1].split('a')[0] : '?';
                return `Analysis: This family has an 'a' value of ${a}. Based on the P-Leaf classification, 'c' is locked to 'a' by a factor of ${k} (a power of 2).`;
            }
            if (leaves.some(l => l.includes('C-Leaf'))) {
                const l = leaves.find(l => l.includes('Mersenne')); const k = l ? l.split('x')[1].replace(')', '') : '?';
                return `Analysis: This is a 'Cryptid' family. The 'b' value is a clean multiple of 'a' (x${k}). This multiplier is a Mersenne Number (2^n - 1).`;
            }
            if (leaves.some(l => l.includes('Q-Leaf'))) {
                let txt = `Analysis: This family is a standard Curve Bender (Q-Leaf). `;
                if (leaves.some(l => l.includes('0±K'))) txt += `It sits on the ground state (Slope 1) with a resonant deviation.`;
                else txt += `It orbits a higher energy state (Slope 2, 4, 8...).`;
                return txt;
            }
            return `Analysis: This family demonstrates the fundamental trunk law $a+d = b+c$.`;
        }

        function renderGraphs(fam) {
            const ctx = document.getElementById('familyChart').getContext('2d');
            const gapCtx = document.getElementById('gapChart').getContext('2d');
            const [a, b, c, d] = fam.family;
            if (currentChart) currentChart.destroy(); if (currentGapChart) currentGapChart.destroy();

            const isQLeaf = fam.leaves.some(l => l.includes('Q-Leaf'));
            const isPLeaf = fam.leaves.some(l => l.includes('P-Leaf'));
            const isLinear = fam.leaves.some(l => l.includes('Linear')); // Catch all linear types
            const isCLeaf = fam.leaves.some(l => l.includes('C-Leaf'));
            
            let datasets = [], yLabel = 'b';
            
            if (isQLeaf) {
                // Find the highest slope mentioned in the leaves
                let bestSlope = 1, bestOffset = 0; 
                fam.leaves.forEach(l => {
                    if (l.includes('Q-Leaf')) {
                        const parts = l.match(/\((\d+)±K\)/);
                        if (parts) {
                            const off = parseInt(parts[1]);
                            if (off > bestOffset) {
                                bestOffset = off;
                                bestSlope = bestOffset + 1;
                            }
                        }
                    }
                });
                
                const targetB = (bestSlope * a) + bestOffset; 
                const K = Math.abs(b - targetB);
                
                datasets = [
                    { label: 'Actual (b)', data: [{x: a, y: b}], backgroundColor: '#c62828', pointRadius: 8 },
                    { label: `Ideal (y=${bestSlope}x+${bestOffset})`, data: [{x: 0, y: bestOffset}, {x: a * 1.5, y: (bestSlope * a * 1.5) + bestOffset}], borderColor: '#3b82f6', borderDash: [5, 5], type: 'line', pointRadius: 0, fill: false },
                    { label: `Deviation K=${K}`, data: [{x: a, y: b}, {x: a, y: targetB}], borderColor: '#c62828', borderWidth: 2, type: 'line', pointRadius: 0 }
                ];
            } else if (isPLeaf) {
                yLabel = 'c'; const l = fam.leaves.find(l => l.includes('c=')); const k = l ? parseInt(l.split('=')[1]) : c/a;
                datasets = [
                    { label: 'Actual (c)', data: [{x: a, y: c}], backgroundColor: '#880e4f', pointRadius: 8 },
                    { label: `Power Function (y=${k}x)`, data: [{x: 0, y: 0}, {x: a * 1.5, y: k * a * 1.5}], borderColor: '#f48fb1', borderDash: [5, 5], type: 'line', pointRadius: 0 }
                ];
            } else if (isCLeaf) {
                const l = fam.leaves.find(l => l.includes('Mersenne')); const k = l ? parseInt(l.split('x')[1]) : b/a;
                datasets = [
                    { label: 'Actual (b)', data: [{x: a, y: b}], backgroundColor: '#004d40', pointRadius: 8 },
                    { label: `Cryptid Function (y=${k}x)`, data: [{x: 0, y: 0}, {x: a * 1.5, y: k * a * 1.5}], borderColor: '#80cbc4', borderDash: [5, 5], type: 'line', pointRadius: 0 }
                ];
            } else if (isLinear) {
                const D = b - a;
                datasets = [
                    { label: 'Anomaly (b)', data: [{x: a, y: b}], backgroundColor: '#d97706', pointRadius: 8 }, 
                    { label: `Linear Anomaly (b=a+${D})`, data: [{x: 0, y: D}, {x: a * 1.5, y: (a * 1.5) + D}], borderColor: '#fbbf24', type: 'line', pointRadius: 0 }
                ];
            } else {
                datasets = [{ label: 'Point', data: [{x: a, y: b}], backgroundColor: '#1f2937', pointRadius: 6 }];
            }

            currentChart = new Chart(ctx, {
                type: 'scatter', data: { datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', position: 'bottom', title: { display: true, text: `Founder (a = ${a})` } }, y: { title: { display: true, text: `Result (${yLabel})` } } }, plugins: { legend: { position: 'bottom' } } }
            });
            currentGapChart = new Chart(gapCtx, {
                type: 'scatter', data: { datasets: [{ label: 'Members', data: [{x: a, y: 0}, {x: b, y: 0}, {x: c, y: 0}, {x: d, y: 0}], backgroundColor: ['#10b981', '#10b981', '#f59e0b', '#f59e0b'], pointRadius: 10 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false, min: -1, max: 1 }, x: { type: 'linear', position: 'bottom' } }, plugins: { title: { display: true, text: `Balance: ${b}-${a} = ${d}-${c}` }, legend: { display: false } } }
            });
        }

        // --- DYNAMIC DUAL FILTERS ---
        function populateMainFilters() {
            const s = document.getElementById('leafFilter'); s.innerHTML = '';
            // Updated group names
            const groups = ["All", "Unclassified", "Category: Q-Leaves (Curve)", "Category: Linear (Resonant)", "Category: C-Leaves (Mersenne)", "Category: P-Leaves (Power)", "Category: Pyth/Fib (Special)"];
            groups.forEach(l => { let o = document.createElement('option'); o.value=l; o.textContent=l; s.appendChild(o); }); 
            s.value = currentLeafFilter;
            populateSubFilters(); 
        }

        function populateSubFilters() {
            const sub = document.getElementById('subLeafFilter'); 
            sub.innerHTML = '<option value="All">All Sub-Types</option>';
            sub.disabled = true; sub.classList.add('bg-gray-50', 'text-gray-500');

            if (currentLeafFilter === "All" || currentLeafFilter === "Unclassified") {
                currentSubFilter = "All";
                return;
            }

            let searchKey = "";
            if (currentLeafFilter.includes("C-Leaves")) searchKey = "C-Leaf";
            if (currentLeafFilter.includes("P-Leaves")) searchKey = "P-Leaf";
            if (currentLeafFilter.includes("Q-Leaves")) searchKey = "Q-Leaf";
            if (currentLeafFilter.includes("Linear")) searchKey = "Linear"; // Added Linear Search Key
            if (currentLeafFilter.includes("Pyth/Fib")) searchKey = "Pyth"; 

            const variants = new Set();
            classifiedData.forEach(f => {
                f.leaves.forEach(l => {
                    if (searchKey === "Pyth") {
                        if (l.includes("Pyth") || l.includes("Fibonacci")) variants.add(l);
                    } else if (l.includes(searchKey)) {
                        variants.add(l);
                    }
                });
            });

            if (variants.size > 0) {
                sub.disabled = false; sub.classList.remove('bg-gray-50', 'text-gray-500');
                // Smart Sort: Try to sort by the number inside (x7, x9, x13)
                [...variants].sort((a,b) => {
                    const getNum = (str) => {
                        const m = str.match(/\d+/g);
                        return m ? parseInt(m[m.length-1]) : 0;
                    };
                    return getNum(a) - getNum(b);
                }).forEach(v => {
                    let o = document.createElement('option'); o.value = v; o.textContent = v; sub.appendChild(o);
                });
            }
        }

        function renderGrid() {
            const grid = document.getElementById('leaf-grid'); grid.innerHTML = "";
            document.getElementById('branch-title').textContent = currentBranch;
            
            let fData = (currentBranch === "All") ? classifiedData : classifiedData.filter(f => f.branch === currentBranch);
            
            if (currentLeafFilter !== "All") {
                if (currentLeafFilter === "Unclassified") fData = fData.filter(f => f.leaves.includes("Unclassified"));
                else if (currentLeafFilter.includes("Linear")) fData = fData.filter(f => f.leaves.some(l => l.includes("Linear")));
                else if (currentLeafFilter.includes("C-Leaves")) fData = fData.filter(f => f.leaves.some(l => l.includes("C-Leaf")));
                else if (currentLeafFilter.includes("P-Leaves")) fData = fData.filter(f => f.leaves.some(l => l.includes("P-Leaf")));
                else if (currentLeafFilter.includes("Q-Leaves")) fData = fData.filter(f => f.leaves.some(l => l.includes("Q-Leaf")));
                else if (currentLeafFilter.includes("Pyth/Fib")) fData = fData.filter(f => f.leaves.some(l => l.includes("Pyth") || l.includes("Fibonacci")));
            }

            if (currentSubFilter !== "All") {
                fData = fData.filter(f => f.leaves.includes(currentSubFilter));
            }

            document.getElementById('leaf-count').textContent = fData.length;

            fData.forEach(fam => {
                const d = document.createElement('div'); d.className = 'leaf-card p-4';
                d.innerHTML = `<h4 class="font-bold text-red-800">Founder: ${fam.N}</h4><p class="font-mono text-xs">{${fam.family.join(', ')}}</p><div class="mt-2">${fam.leaves.map(l=>`<span class="leaf-trait ${l.includes('Q')?'q-leaf':l.includes('P')?'p-leaf':l.includes('Linear')?'l-leaf':l.includes('C-Leaf')?'c-leaf':'unclassified'}" style="font-size:10px">${l}</span>`).join('')}</div>`;
                d.onclick = () => {
                    document.getElementById('familyModal').style.display='flex';
                    const analysis = getAnalysisText(fam);
                    document.getElementById('modal-body').innerHTML = `<div class="bg-gray-100 p-4 rounded text-center font-mono text-xl">{${fam.family.join(', ')}}</div><p class="mt-4"><strong>Leaves:</strong> ${fam.leaves.join(', ')}</p><p class="text-sm text-gray-700 mt-4 italic border-l-4 border-red-700 pl-3">${analysis}</p>`;
                    setTimeout(() => renderGraphs(fam), 100);
                };
                grid.appendChild(d);
            });
        }

        async function runScan() {
            const btn = document.getElementById('scanButton'); btn.disabled = true; btn.textContent = "Scanning...";
            document.getElementById('summary').textContent = "Scanning..."; document.getElementById('leaf-grid').innerHTML = "";
            setTimeout(() => {
                const max = parseInt(document.getElementById('maxLimit').value); generateFibonacciSet(max);
                const start = performance.now(); const processed = new Set(); const families = [];
                for(let n=2; n<=max; n++) {
                    if(processed.has(n)) continue;
                    let k = n.toString(2).length; let fam = getRotationalFamily(generateMatrix(toBinary(n, k)));
                    new Set(fam).forEach(x => processed.add(x));
                    if(new Set(fam).size === 4) { let sorted = fam.sort((x,y)=>x-y); families.push({ N: n, k: k, family: sorted }); }
                }
                allFamilies = families; classifiedData = []; knownLeaves.clear();
                allFamilies.forEach(f => {
                    const [a,b,c,d] = f.family; const sum = a+d;
                    classifiedData.push({ ...f, sum: sum, branch: getBranchFromSum(sum), leaves: getLeavesForFamily(f.family, f.N, sum) });
                });
                document.getElementById('summary').textContent = `Scanned ${allFamilies.length} families in ${((performance.now()-start)/1000).toFixed(2)}s.`;
                btn.disabled = false; btn.textContent = "Scan and Classify";
                populateSidebar(); populateMainFilters(); renderGrid();
            }, 50);
        }
        function populateSidebar() {
            const branches = [...new Set(classifiedData.map(f => f.branch))].sort((a,b)=>{const nA=parseInt(a.substring(1)),nB=parseInt(b.substring(1));return (isNaN(nA)?1:isNaN(nB)?-1:nA-nB)});
            const list = document.getElementById('branch-list'); list.innerHTML = "";
            branches.forEach(b => {
                const link = document.createElement('a'); link.className = 'branch-link'; link.textContent = `${b} (Sum ${Math.pow(2, parseInt(b.substring(1))) - 1})`;
                link.onclick = () => { currentBranch = b; updateActiveBranch(link); renderGrid(); }; list.appendChild(link);
            });
            const allLink = document.querySelector('.branch-link[data-branch="All"]');
            if(allLink) { allLink.classList.add('active'); allLink.onclick = () => { currentBranch="All"; updateActiveBranch(allLink); renderGrid(); }};
            currentBranch = "All";
        }
        function updateActiveBranch(el) { document.querySelectorAll('.branch-link.active').forEach(l => l.classList.remove('active')); el.classList.add('active'); }
        
        // --- EVENT HANDLERS ---
        document.getElementById('scanButton').onclick = runScan;
        
        document.getElementById('leafFilter').onchange = (e) => { 
            currentLeafFilter = e.target.value; 
            currentSubFilter = "All"; // Reset sub filter
            populateSubFilters();
            renderGrid(); 
        };
        document.getElementById('subLeafFilter').onchange = (e) => {
            currentSubFilter = e.target.value;
            renderGrid();
        };

        // Updated "Find New" to focus on anomalies
        document.getElementById('findNewButton').onclick = () => {
            const el = document.getElementById('analysis-results'); 
            const anomalies = classifiedData.filter(f => f.leaves.some(l => l.includes("Linear (")));
            const unclassified = classifiedData.filter(f => f.leaves.includes("Unclassified"));
            
            let txt = "";
            if(anomalies.length > 0) txt += `Found ${anomalies.length} Harmonic Anomalies (Factors 7, 9, 13...).\n`;
            if(unclassified.length > 0) txt += `Found ${unclassified.length} Unclassified Families.\n`;
            if(txt === "") txt = "System Clean. All families unified under Q/C/P/Fib laws.";
            
            el.textContent = txt;
        };
        
        function exportUnclassified(type) {
            const val = document.getElementById('export-data'); const un = classifiedData.filter(f => f.leaves.includes("Unclassified"));
            if(type === 'json') val.value = JSON.stringify(un.map(f=>({N:f.N, family:f.family})), null, 2); else val.value = un.map(f=>`${f.N} - {${f.family.join(', ')}}`).join('\n');
        }
        function exportLinearDValues() {
            // Updated exporter to show the Factors, not just D
            const factors = new Set();
            classifiedData.forEach(f => {
                f.leaves.forEach(l => {
                    if (l.includes("Linear (")) {
                        factors.add(l.split('(')[1].replace(')', ''));
                    }
                });
            });
            document.getElementById('export-data').value = `Harmonic Factors: [${[...factors].sort().join(', ')}]`;
        }
        
        document.getElementById('exportButton').onclick = () => exportUnclassified('json');
        document.getElementById('exportSimpleButton').onclick = () => exportUnclassified('simple');
        document.getElementById('exportDValuesButton').onclick = exportLinearDValues;
        document.getElementById('closeModal').onclick = () => document.getElementById('familyModal').style.display='none';
        document.getElementById('familyModal').onclick = (e) => { if(e.target.id==='familyModal') e.target.style.display='none'; };
        document.getElementById('closeGuide').onclick = () => document.getElementById('guideModal').style.display='none';
        document.getElementById('openGuideBtn').onclick = () => document.getElementById('guideModal').style.display='flex';
        document.getElementById('guideModal').onclick = (e) => { if(e.target.id==='guideModal') e.target.style.display='none'; };
        
        runScan();
    </script>
</body>
</html>